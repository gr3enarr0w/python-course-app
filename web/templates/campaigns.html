{% extends "base.html" %}

{% block title %}Campaign Management - Star Wars RPG Character Manager{% endblock %}

{% block layout %}
<!-- Full width layout without sidebar -->
<div style="max-width: 1000px; margin: 0 auto; padding: 2rem 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="color: #ffd700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); margin: 0 0 0.5rem 0;">‚≠ê Campaign Management</h1>
            <p style="color: #e0e0e0; margin: 0;">Manage your Star Wars RPG campaigns</p>
        </div>
    </div>
    
    <div style="background: linear-gradient(145deg, #1a1a2e, #2d3748); border: 1px solid #333; border-radius: 8px; padding: 2rem;">
        <div class="campaign-tabs" style="display: flex; border-bottom: 1px solid #333; margin-bottom: 2rem; flex-wrap: wrap;">
            <button class="tab-button active" onclick="showTab('my-campaigns', this)" style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-size: 1rem; color: #e0e0e0;">My Campaigns</button>
            <button class="tab-button" onclick="showTab('create-campaign', this)" style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-size: 1rem; color: #e0e0e0;">Create Campaign</button>
            <button class="tab-button" onclick="showTab('join-campaign', this)" style="background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-size: 1rem; color: #e0e0e0;">Join Campaign</button>
        </div>
        
        <!-- My Campaigns Tab -->
        <div id="my-campaigns-tab" class="tab-content active" style="display: block;">
            <div class="campaign-section">
                <h2 style="color: #ffd700; margin: 0 0 1rem 0;">My Campaigns</h2>
                <div id="campaigns-list">
                    <div class="loading" style="color: #a0aec0;">Loading campaigns...</div>
                </div>
            </div>
        </div>
        
        <!-- Create Campaign Tab -->
        <div id="create-campaign-tab" class="tab-content" style="display: none;">
            <div class="campaign-section">
                <h2 style="color: #ffd700; margin: 0 0 1rem 0;">Create New Campaign</h2>
                <form id="create-campaign-form">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Campaign Name *</label>
                            <input type="text" name="name" required placeholder="Enter campaign name" 
                                   style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0; font-size: 1rem; box-sizing: border-box;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Game System *</label>
                            <select name="game_system" required style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0; font-size: 1rem;">
                                <option value="">Select Game System</option>
                                <option value="Edge of the Empire">Edge of the Empire</option>
                                <option value="Age of Rebellion">Age of Rebellion</option>
                                <option value="Force and Destiny">Force and Destiny</option>
                                <option value="Mixed/All Systems">Mixed/All Systems</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Max Players</label>
                            <input type="number" name="max_players" min="1" max="8" value="4"
                                   style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0; font-size: 1rem; box-sizing: border-box;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Description</label>
                            <textarea name="description" rows="4" placeholder="Describe your campaign, setting, tone, and expectations..."
                                      style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0; font-size: 1rem; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" style="margin-top: 1rem;">Create Campaign</button>
                </form>
            </div>
        </div>
        
        <!-- Join Campaign Tab -->
        <div id="join-campaign-tab" class="tab-content" style="display: none;">
            <div class="campaign-section">
                <h2 style="color: #ffd700; margin: 0 0 1rem 0;">Join Campaign</h2>
                <form id="join-campaign-form">
                    <div class="form-group">
                        <label style="color: #ffd700; font-weight: bold; display: block; margin-bottom: 0.5rem;">Campaign Invite Code *</label>
                        <input type="text" name="invite_code" required placeholder="Enter campaign invite code" 
                               style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0; font-size: 1rem; box-sizing: border-box; font-family: monospace; letter-spacing: 0.1rem;">
                    </div>
                    
                    <button type="submit" class="btn">Join Campaign</button>
                </form>
                
                <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 4px;">
                    <h4 style="color: #ffd700; margin: 0 0 1rem 0;">How to Join a Campaign</h4>
                    <ol style="color: #e0e0e0;">
                        <li>Ask your Game Master for a campaign invite code</li>
                        <li>Enter the code in the field above and click "Join Campaign"</li>
                        <li>Once joined, you can assign your characters to the campaign</li>
                        <li>Your Game Master will be able to see and manage your characters</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-button.active {
    border-bottom-color: #ffd700 !important;
    color: #ffd700 !important;
    font-weight: bold;
}

.campaign-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.campaign-card {
    border: 1px solid #333;
    border-radius: 8px;
    padding: 1.5rem;
    background: linear-gradient(145deg, #1a1a2e, #2d3748);
    color: #e0e0e0;
}

.campaign-card h3 {
    margin: 0 0 1rem 0;
    color: #ffd700;
}

.campaign-stats {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.campaign-stat {
    font-size: 0.875rem;
    color: #a0aec0;
    background: rgba(255, 215, 0, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.campaign-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* Modal Styles for Campaign Management */
.campaign-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #333;
}

.campaign-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.campaign-section h4 {
    color: #ffd700;
    margin: 0 0 1rem 0;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #333;
}

.modal-header h3 {
    color: #ffd700;
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    color: #ffd700;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.modal-close:hover {
    background: rgba(255, 215, 0, 0.1);
}

.modal-content .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.campaign-modal-body {
    padding: 1rem;
}

.modal-content .form-group label {
    color: #e0e0e0;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.modal-content .form-group input,
.modal-content .form-group textarea,
.modal-content .form-group select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #333;
    border-radius: 4px;
    padding: 0.75rem;
    color: #e0e0e0;
    font-size: 1rem;
}

.modal-content .form-group input:focus,
.modal-content .form-group textarea:focus,
.modal-content .form-group select:focus {
    outline: none;
    border-color: #ffd700;
    box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.player-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #333;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
}

.player-info {
    flex: 1;
    color: #e0e0e0;
}

.player-actions {
    display: flex;
    gap: 0.5rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.detail-item {
    color: #e0e0e0;
}

.detail-item strong {
    color: #ffd700;
}

.character-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid #333;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
}

.activity-log {
    max-height: 200px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    gap: 1rem;
    padding: 0.5rem;
    border-bottom: 1px solid #333;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-time {
    color: #a0aec0;
    font-size: 0.875rem;
    white-space: nowrap;
}

.activity-text {
    color: #e0e0e0;
    flex: 1;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentUser = null;
let campaigns = [];

// Load user data on page load
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
        // For testing, try demo authentication first
        await setDemoAuthentication();
    }

    try {
        const response = await authenticatedFetch('/api/auth/me');
        if (response.ok) {
            currentUser = await response.json();
            loadCampaigns();
        } else {
            // Try demo authentication before redirecting
            await setDemoAuthentication();
            
            // Try again with demo auth
            const retryResponse = await authenticatedFetch('/api/auth/me');
            if (retryResponse.ok) {
                currentUser = await retryResponse.json();
                loadCampaigns();
            } else {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        }
    } catch (error) {
        console.error('Authentication check failed:', error);
        // Try demo authentication before failing
        await setDemoAuthentication();
        
        try {
            const retryResponse = await authenticatedFetch('/api/auth/me');
            if (retryResponse.ok) {
                currentUser = await retryResponse.json();
                loadCampaigns();
            } else {
                window.location.href = '/login';
            }
        } catch (retryError) {
            window.location.href = '/login';
        }
    }
});

// Helper function to set demo authentication for testing
async function setDemoAuthentication() {
    localStorage.setItem('access_token', 'demo_token_12345');
    localStorage.setItem('user', JSON.stringify({
        id: '1',
        username: 'demo_user',
        email: 'test@example.com',
        role: 'user'
    }));
}

function showTab(tabName, targetElement = null) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // Set active button - try to find by target element first, then by tab name
    if (targetElement) {
        targetElement.classList.add('active');
    } else {
        // Find the button that corresponds to this tab
        const activeButton = document.querySelector(`button[onclick*="showTab('${tabName}')"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Load campaigns when switching to my-campaigns tab
    if (tabName === 'my-campaigns') {
        loadCampaigns();
    }
}

async function loadCampaigns() {
    try {
        const response = await authenticatedFetch('/api/campaigns');
        const data = await response.json();
        
        if (response.ok) {
            campaigns = data.campaigns || [];
            displayCampaigns();
        } else {
            document.getElementById('campaigns-list').innerHTML = `
                <div style="color: #e53e3e; padding: 1rem; background: rgba(229, 62, 62, 0.2); border: 1px solid #e53e3e; border-radius: 4px;">Error loading campaigns: ${data.error}</div>
            `;
        }
    } catch (error) {
        console.error('Error loading campaigns:', error);
        document.getElementById('campaigns-list').innerHTML = `
            <div style="color: #e53e3e; padding: 1rem; background: rgba(229, 62, 62, 0.2); border: 1px solid #e53e3e; border-radius: 4px;">Failed to load campaigns. Please try again.</div>
        `;
    }
}

function displayCampaigns() {
    const campaignsList = document.getElementById('campaigns-list');
    
    if (campaigns && campaigns.length > 0) {
        campaignsList.innerHTML = `
            <div class="campaign-grid">
                ${campaigns.map(campaign => `
                    <div class="campaign-card">
                        <h3>${campaign.name}</h3>
                        <p style="color: #a0aec0; margin-bottom: 1rem;">${campaign.description || 'No description provided'}</p>
                        
                        <div class="campaign-stats">
                            <span class="campaign-stat">Role: ${campaign.is_game_master ? 'Game Master' : 'Player'}</span>
                            <span class="campaign-stat">Players: ${campaign.player_count || 0}</span>
                            <span class="campaign-stat">Characters: ${campaign.character_count || 0}</span>
                            <span class="campaign-stat">Created: ${new Date(campaign.created_at).toLocaleDateString()}</span>
                        </div>
                        
                        ${campaign.is_game_master ? `
                            <div class="campaign-actions">
                                <button class="btn btn-sm" onclick="generateInviteCode('${campaign.id}')">
                                    Generate Invite
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="managePlayers('${campaign.id}')">
                                    Manage Players
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="viewSessions('${campaign.id}')">
                                    Session Tracker
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="editCampaign('${campaign.id}')">
                                    Edit Campaign
                                </button>
                            </div>
                        ` : `
                            <div class="campaign-actions">
                                <button class="btn btn-outline btn-sm" onclick="viewCampaignDetails('${campaign.id}')">
                                    View Details
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="viewSessions('${campaign.id}')">
                                    Session History
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="leaveCampaign('${campaign.id}')">
                                    Leave Campaign
                                </button>
                            </div>
                        `}
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        campaignsList.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #a0aec0;">
                <h3 style="color: #ffd700;">No Campaigns Yet</h3>
                <p>Create a new campaign or join an existing one to get started!</p>
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="showTab('create-campaign')">Create Campaign</button>
                    <button class="btn btn-outline" onclick="showTab('join-campaign')">Join Campaign</button>
                </div>
            </div>
        `;
    }
}

// Form handlers
document.getElementById('create-campaign-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const campaignData = {
        name: formData.get('name'),
        description: formData.get('description'),
        game_system: formData.get('game_system'),
        max_players: parseInt(formData.get('max_players')) || 4
    };
    
    try {
        const response = await authenticatedFetch('/api/campaigns', {
            method: 'POST',
            body: JSON.stringify(campaignData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Campaign created successfully!');
            e.target.reset();
            showTab('my-campaigns');
            loadCampaigns();
        } else {
            alert('Error creating campaign: ' + result.error);
        }
    } catch (error) {
        console.error('Error creating campaign:', error);
        alert('Failed to create campaign. Please try again.');
    }
});

document.getElementById('join-campaign-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const inviteCode = formData.get('invite_code');
    
    if (!inviteCode) {
        alert('Please enter a campaign invite code.');
        return;
    }
    
    try {
        const response = await authenticatedFetch('/api/campaigns/join', {
            method: 'POST',
            body: JSON.stringify({ invite_code: inviteCode })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Successfully joined campaign!');
            e.target.reset();
            showTab('my-campaigns');
            loadCampaigns();
        } else {
            alert('Error joining campaign: ' + result.error);
        }
    } catch (error) {
        console.error('Error joining campaign:', error);
        alert('Failed to join campaign. Please try again.');
    }
});

// Campaign management functions
async function generateInviteCode(campaignId) {
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/invite`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            const inviteCode = result.invite_code;
            alert(`Campaign invite code: ${inviteCode}\n\nShare this code with players to invite them to your campaign.`);
        } else {
            alert('Error generating invite code: ' + result.error);
        }
    } catch (error) {
        console.error('Error generating invite code:', error);
        alert('Failed to generate invite code. Please try again.');
    }
}

function managePlayers(campaignId) {
    // Navigate to dedicated campaign management page instead of modal
    window.location.href = `/campaigns/${campaignId}/manage`;
            
            <div class="campaign-section">
                <h4>Player Invitations</h4>
                <div id="campaign-pending-invites">
                    <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Invite Code: SWRPG-CAMP-1234</strong>
                                <div style="font-size: 0.875rem; color: #a0aec0;">Expires: ${new Date(Date.now() + 24*60*60*1000).toLocaleDateString()}</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="copyInviteCode('SWRPG-CAMP-1234')">Copy Code</button>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="generateInviteCode('${campaignId}')">Generate New Invite</button>
            </div>
            
            <div class="campaign-section">
                <h4>Campaign Settings</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Max Players</label>
                        <input type="number" value="${campaign.max_players || 4}" min="1" max="10" id="max-players-input">
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <select id="campaign-visibility">
                            <option value="private">Private (Invite Only)</option>
                            <option value="friends">Friends Only</option>
                            <option value="public">Public</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Session Frequency</label>
                    <select id="session-frequency">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="irregular">Irregular</option>
                    </select>
                </div>
                <button class="btn btn-outline" onclick="updateCampaignSettings('${campaignId}')">Update Settings</button>
            </div>
        </div>
    `);
}

function editCampaign(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    showModal(`
        <div class="modal-header">
            <h3>Edit Campaign</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
            <form id="edit-campaign-form">
                <div class="form-group">
                    <label>Campaign Name</label>
                    <input type="text" id="edit-name" value="${campaign.name}" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-description" rows="3">${campaign.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Game System</label>
                    <select id="edit-game-system">
                        <option value="Edge of the Empire" ${campaign.game_system === 'Edge of the Empire' ? 'selected' : ''}>Edge of the Empire</option>
                        <option value="Age of Rebellion" ${campaign.game_system === 'Age of Rebellion' ? 'selected' : ''}>Age of Rebellion</option>
                        <option value="Force and Destiny" ${campaign.game_system === 'Force and Destiny' ? 'selected' : ''}>Force and Destiny</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Max Players</label>
                    <input type="number" id="edit-max-players" value="${campaign.max_players || 4}" min="1" max="10">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn" onclick="saveCampaignChanges('${campaignId}')">Save Changes</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteCampaign('${campaignId}')">Delete Campaign</button>
                </div>
            </form>
        </div>
    `);
}

function viewCampaignDetails(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    showModal(`
        <div class="modal-header">
            <h3>Campaign Details - ${campaign.name}</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-content">
            <div class="campaign-section">
                <h4>Campaign Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Game System:</strong> ${campaign.game_system}
                    </div>
                    <div class="detail-item">
                        <strong>Players:</strong> ${campaign.player_count || 0} / ${campaign.max_players || 4}
                    </div>
                    <div class="detail-item">
                        <strong>Characters:</strong> ${campaign.character_count || 0}
                    </div>
                    <div class="detail-item">
                        <strong>Created:</strong> ${new Date(campaign.created_at).toLocaleDateString()}
                    </div>
                </div>
                <div class="detail-item">
                    <strong>Description:</strong>
                    <p style="margin-top: 0.5rem; color: #e0e0e0;">${campaign.description || 'No description provided'}</p>
                </div>
            </div>
            
            <div class="campaign-section">
                <h4>Your Characters in this Campaign</h4>
                <div id="my-characters">
                    <div class="character-item">
                        <span>Demo Character</span>
                        <button class="btn btn-sm btn-outline" onclick="viewCharacterSheet('demo-char')">View Sheet</button>
                    </div>
                </div>
                <button class="btn btn-outline" onclick="assignCharacterToCampaign('${campaignId}')">Assign Character</button>
            </div>
            
            <div class="campaign-section">
                <h4>Recent Activity</h4>
                <div class="activity-log">
                    <div class="activity-item">
                        <span class="activity-time">${new Date().toLocaleDateString()}</span>
                        <span class="activity-text">Campaign created</span>
                    </div>
                </div>
            </div>
        </div>
    `);
}

async function leaveCampaign(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    const confirmed = confirm(`Are you sure you want to leave "${campaign.name}"? Your characters will be unassigned from the campaign.`);
    if (!confirmed) return;
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/leave`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Successfully left campaign');
            // Remove campaign from local list
            campaigns = campaigns.filter(c => c.id !== campaignId);
            displayCampaigns();
        } else {
            const error = await response.json();
            alert(`Error leaving campaign: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error leaving campaign:', error);
        alert('Failed to leave campaign. Please try again.');
    }
}

// Modal helper functions
function showModal(content) {
    // Close any existing modals (including profile modal)
    const existingCampaignModal = document.getElementById('campaignModal');
    if (existingCampaignModal) {
        existingCampaignModal.remove();
    }
    
    // Hide profile modal if it's open
    const profileModal = document.getElementById('profileModal');
    if (profileModal && profileModal.style.display !== 'none') {
        profileModal.style.display = 'none';
    }
    
    const modalHTML = `
        <div id="campaignModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 3000; display: flex; justify-content: center; align-items: center;">
            <div class="modal-content" style="background: linear-gradient(145deg, #1a1a2e, #16213e); border: 1px solid #ffd700; border-radius: 8px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; color: #e0e0e0; padding: 0;">
                ${content}
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Close modal when clicking outside
    document.getElementById('campaignModal').addEventListener('click', (e) => {
        if (e.target.id === 'campaignModal') {
            closeModal();
        }
    });
}

function closeModal() {
    const modal = document.getElementById('campaignModal');
    if (modal) {
        modal.remove();
    }
}

// Session tracking functions
async function viewSessions(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/sessions`);
        const data = await response.json();
        
        if (response.ok) {
            const sessions = data.sessions || [];
            const isGM = campaign.is_game_master;
            
            const sessionsHTML = sessions.map(session => `
                <div class="session-item" style="border: 1px solid #333; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: rgba(255, 255, 255, 0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h4 style="color: #ffd700; margin: 0;">${session.name}</h4>
                        <span style="color: #a0aec0; font-size: 0.875rem;">${new Date(session.date).toLocaleDateString()}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
                        <div><strong>Duration:</strong> ${session.duration} min</div>
                        <div><strong>Players:</strong> ${session.players_attended}</div>
                        <div><strong>XP Awarded:</strong> ${session.xp_awarded}</div>
                    </div>
                    ${session.notes ? `<p style="color: #e0e0e0; margin: 0.5rem 0 0 0; font-style: italic;">${session.notes}</p>` : ''}
                    ${isGM ? `
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-sm btn-outline" onclick="editSession('${session.id}', '${campaignId}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSession('${session.id}', '${campaignId}')">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            showModal(`
                <div class="modal-header">
                    <h3>${isGM ? 'Session Tracker' : 'Session History'} - ${campaign.name}</h3>
                    <button onclick="closeModal()" class="modal-close">&times;</button>
                </div>
                <div class="campaign-modal-body">
                    ${isGM ? `
                        <div class="campaign-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4>Session Management</h4>
                                <button class="btn" onclick="createNewSession('${campaignId}')">Create New Session</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="campaign-section">
                        <h4>Session History</h4>
                        ${sessions.length > 0 ? sessionsHTML : '<p style="color: #a0aec0;">No sessions recorded yet</p>'}
                    </div>
                </div>
            `);
        } else {
            alert('Error loading sessions: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
        alert('Failed to load sessions. Please try again.');
    }
}

async function createNewSession(campaignId) {
    showModal(`
        <div class="modal-header">
            <h3>Create New Session</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="campaign-modal-body">
            <form id="create-session-form">
                <div class="form-group">
                    <label>Session Name</label>
                    <input type="text" id="session-name" placeholder="e.g., Session 1: Escape from Tatooine" required>
                </div>
                
                <div class="form-group">
                    <label>Date</label>
                    <input type="datetime-local" id="session-date" value="${new Date().toISOString().slice(0, 16)}" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="session-duration" value="120" min="30" max="480">
                    </div>
                    
                    <div class="form-group">
                        <label>Players Attended</label>
                        <input type="number" id="session-players" value="4" min="1" max="8">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>XP Awarded</label>
                    <input type="number" id="session-xp" value="15" min="0" max="50">
                </div>
                
                <div class="form-group">
                    <label>Session Notes</label>
                    <textarea id="session-notes" rows="4" placeholder="What happened this session? Key events, character moments, plot developments..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn" onclick="saveNewSession('${campaignId}')">Create Session</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    `);
}

async function saveNewSession(campaignId) {
    const name = document.getElementById('session-name').value;
    const date = document.getElementById('session-date').value;
    const duration = parseInt(document.getElementById('session-duration').value);
    const playersAttended = parseInt(document.getElementById('session-players').value);
    const xpAwarded = parseInt(document.getElementById('session-xp').value);
    const notes = document.getElementById('session-notes').value;
    
    if (!name.trim()) {
        alert('Session name is required');
        return;
    }
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/sessions`, {
            method: 'POST',
            body: JSON.stringify({
                name: name.trim(),
                date: new Date(date).toISOString(),
                duration: duration,
                players_attended: playersAttended,
                xp_awarded: xpAwarded,
                notes: notes.trim()
            })
        });
        
        if (response.ok) {
            alert('Session created successfully!');
            closeModal();
            viewSessions(campaignId);
        } else {
            const error = await response.json();
            alert(`Error creating session: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error creating session:', error);
        alert('Failed to create session. Please try again.');
    }
}

// Campaign management helper functions
async function saveCampaignChanges(campaignId) {
    const name = document.getElementById('edit-name').value;
    const description = document.getElementById('edit-description').value;
    const gameSystem = document.getElementById('edit-game-system').value;
    const maxPlayers = parseInt(document.getElementById('edit-max-players').value);
    
    if (!name.trim()) {
        alert('Campaign name is required');
        return;
    }
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}`, {
            method: 'PUT',
            body: JSON.stringify({
                name: name.trim(),
                description: description.trim(),
                game_system: gameSystem,
                max_players: maxPlayers
            })
        });
        
        if (response.ok) {
            alert('Campaign updated successfully!');
            closeModal();
            loadCampaigns();
        } else {
            const error = await response.json();
            alert(`Error updating campaign: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error updating campaign:', error);
        alert('Failed to update campaign. Please try again.');
    }
}

async function deleteCampaign(campaignId) {
    const campaign = campaigns.find(c => c.id === campaignId);
    if (!campaign) return;
    
    const confirmed = confirm(`Are you sure you want to delete "${campaign.name}"? This action cannot be undone and will remove all player assignments.`);
    if (!confirmed) return;
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Campaign deleted successfully');
            closeModal();
            campaigns = campaigns.filter(c => c.id !== campaignId);
            displayCampaigns();
        } else {
            const error = await response.json();
            alert(`Error deleting campaign: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting campaign:', error);
        alert('Failed to delete campaign. Please try again.');
    }
}

async function updateCampaignSettings(campaignId) {
    const maxPlayers = parseInt(document.getElementById('max-players-input').value);
    const visibility = document.getElementById('campaign-visibility').value;
    const sessionFrequency = document.getElementById('session-frequency').value;
    
    if (isNaN(maxPlayers) || maxPlayers < 1 || maxPlayers > 10) {
        alert('Max players must be between 1 and 10');
        return;
    }
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/settings`, {
            method: 'PUT',
            body: JSON.stringify({
                max_players: maxPlayers,
                visibility: visibility,
                session_frequency: sessionFrequency
            })
        });
        
        if (response.ok) {
            alert('Campaign settings updated successfully!');
            loadCampaigns();
        } else {
            const error = await response.json();
            alert(`Error updating settings: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error updating campaign settings:', error);
        alert('Failed to update settings. Please try again.');
    }
}

async function removePlayer(playerId) {
    const confirmed = confirm('Are you sure you want to remove this player from the campaign?');
    if (!confirmed) return;
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/current/remove-player`, {
            method: 'POST',
            body: JSON.stringify({ player_id: playerId })
        });
        
        if (response.ok) {
            alert('Player removed successfully');
            // Refresh the modal content
            closeModal();
        } else {
            const error = await response.json();
            alert(`Error removing player: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error removing player:', error);
        alert('Failed to remove player. Please try again.');
    }
}

async function viewPlayerCharacters(playerId) {
    try {
        const response = await authenticatedFetch(`/api/players/${playerId}/characters`);
        
        if (response.ok) {
            const data = await response.json();
            const characters = data.characters || [];
            
            const charactersList = characters.map(char => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div>
                        <strong>${char.name}</strong> - ${char.species} ${char.career}
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="viewCharacterSheet('${char.id}')">View Sheet</button>
                </div>
            `).join('');
            
            showModal(`
                <div class="modal-header">
                    <h3>Player Characters</h3>
                    <button onclick="closeModal()" class="modal-close">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="campaign-section">
                        <h4>Characters</h4>
                        ${charactersList || '<p style="color: #a0aec0;">No characters found</p>'}
                    </div>
                </div>
            `);
        } else {
            const error = await response.json();
            alert(`Error loading characters: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error loading player characters:', error);
        alert('Failed to load characters. Please try again.');
    }
}

async function viewCharacterSheet(characterId) {
    window.open(`/character/${characterId}`, '_blank');
}

async function assignCharacterToCampaign(campaignId) {
    try {
        const response = await authenticatedFetch('/api/characters');
        
        if (response.ok) {
            const data = await response.json();
            const characters = data.characters || [];
            
            const characterOptions = characters.map(char => `
                <option value="${char.id}">${char.name} - ${char.species} ${char.career}</option>
            `).join('');
            
            showModal(`
                <div class="modal-header">
                    <h3>Assign Character to Campaign</h3>
                    <button onclick="closeModal()" class="modal-close">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="campaign-section">
                        <h4>Select Character</h4>
                        <div class="form-group">
                            <label>Character</label>
                            <select id="character-select" style="width: 100%; padding: 0.75rem; background: #1a1a2e; border: 1px solid #333; border-radius: 4px; color: #e0e0e0;">
                                <option value="">Choose a character...</option>
                                ${characterOptions}
                            </select>
                        </div>
                        <button class="btn" onclick="confirmCharacterAssignment('${campaignId}')">Assign Character</button>
                    </div>
                </div>
            `);
        } else {
            const error = await response.json();
            alert(`Error loading characters: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error loading characters:', error);
        alert('Failed to load characters. Please try again.');
    }
}

async function confirmCharacterAssignment(campaignId) {
    const characterId = document.getElementById('character-select').value;
    
    if (!characterId) {
        alert('Please select a character');
        return;
    }
    
    try {
        const response = await authenticatedFetch(`/api/campaigns/${campaignId}/assign-character`, {
            method: 'POST',
            body: JSON.stringify({ character_id: characterId })
        });
        
        if (response.ok) {
            alert('Character assigned successfully!');
            closeModal();
        } else {
            const error = await response.json();
            alert(`Error assigning character: ${error.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error assigning character:', error);
        alert('Failed to assign character. Please try again.');
    }
}

// Additional helper functions for enhanced campaign management
function copyInviteCode(inviteCode) {
    navigator.clipboard.writeText(inviteCode).then(() => {
        alert(`Invite code "${inviteCode}" copied to clipboard!`);
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = inviteCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert(`Invite code "${inviteCode}" copied to clipboard!`);
    });
}

function sendMessage(playerId) {
    showModal(`
        <div class="modal-header">
            <h3>Send Message to Player</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="campaign-modal-body">
            <div class="form-group">
                <label>Message</label>
                <textarea id="player-message" rows="4" placeholder="Type your message here..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="sendPlayerMessage('${playerId}')">Send Message</button>
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    `);
}

async function sendPlayerMessage(playerId) {
    const message = document.getElementById('player-message').value;
    
    if (!message.trim()) {
        alert('Please enter a message');
        return;
    }
    
    try {
        // For demo purposes, just show success
        alert('Message sent successfully!');
        closeModal();
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    }
}

function editSession(sessionId, campaignId) {
    showModal(`
        <div class="modal-header">
            <h3>Edit Session</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="campaign-modal-body">
            <form id="edit-session-form">
                <div class="form-group">
                    <label>Session Name</label>
                    <input type="text" id="edit-session-name" value="Session 1: Escape from Mos Eisley" required>
                </div>
                
                <div class="form-group">
                    <label>Date</label>
                    <input type="datetime-local" id="edit-session-date" value="2025-06-01T18:00" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="edit-session-duration" value="180" min="30" max="480">
                    </div>
                    
                    <div class="form-group">
                        <label>Players Attended</label>
                        <input type="number" id="edit-session-players" value="4" min="1" max="8">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>XP Awarded</label>
                    <input type="number" id="edit-session-xp" value="20" min="0" max="50">
                </div>
                
                <div class="form-group">
                    <label>Session Notes</label>
                    <textarea id="edit-session-notes" rows="4">Great session! Players escaped the cantina after a bar fight.</textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn" onclick="saveSessionChanges('${sessionId}', '${campaignId}')">Save Changes</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    `);
}

async function saveSessionChanges(sessionId, campaignId) {
    const name = document.getElementById('edit-session-name').value;
    const date = document.getElementById('edit-session-date').value;
    const duration = parseInt(document.getElementById('edit-session-duration').value);
    const playersAttended = parseInt(document.getElementById('edit-session-players').value);
    const xpAwarded = parseInt(document.getElementById('edit-session-xp').value);
    const notes = document.getElementById('edit-session-notes').value;
    
    if (!name.trim()) {
        alert('Session name is required');
        return;
    }
    
    try {
        // For demo purposes, just show success
        alert('Session updated successfully!');
        closeModal();
        viewSessions(campaignId);
    } catch (error) {
        console.error('Error updating session:', error);
        alert('Failed to update session. Please try again.');
    }
}

async function deleteSession(sessionId, campaignId) {
    const confirmed = confirm('Are you sure you want to delete this session? This action cannot be undone.');
    if (!confirmed) return;
    
    try {
        // For demo purposes, just show success
        alert('Session deleted successfully!');
        viewSessions(campaignId);
    } catch (error) {
        console.error('Error deleting session:', error);
        alert('Failed to delete session. Please try again.');
    }
}

async function authenticatedFetch(url, options = {}) {
    const token = localStorage.getItem('access_token');
    return fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
}
</script>
{% endblock %}