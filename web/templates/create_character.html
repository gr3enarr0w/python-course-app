{% extends "base.html" %}

{% block title %}Create Character - Star Wars RPG Character Manager{% endblock %}

{% block sidebar_content %}
<!-- Character Creation Help -->
<div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 4px;">
    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">Creation Guide</h4>
    <div style="color: #e0e0e0; font-size: 0.875rem; line-height: 1.4;">
        <p>1. Choose your species carefully - it affects starting characteristics and XP</p>
        <p>2. Select a career that matches your desired playstyle</p>
        <p>3. Add background details to bring your character to life</p>
    </div>
</div>

<!-- Species Quick Reference -->
<div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255, 215, 0, 0.05); border: 1px solid #333; border-radius: 4px;">
    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">Popular Species</h4>
    <div style="color: #e0e0e0; font-size: 0.875rem;">
        <div style="margin-bottom: 0.25rem;"><strong>Human:</strong> Versatile, 110 XP</div>
        <div style="margin-bottom: 0.25rem;"><strong>Twi'lek:</strong> Social, High Cunning</div>
        <div style="margin-bottom: 0.25rem;"><strong>Wookiee:</strong> Strong, High Brawn</div>
        <div><strong>Rodian:</strong> Agile, Good for hunters</div>
    </div>
</div>

<!-- Navigation -->
<div>
    <a href="{{ url_for('index') }}" class="btn btn-outline" style="width: 100%; text-align: center; margin-bottom: 0.5rem;">
        ‚Üê Back to Dashboard
    </a>
    <a href="{{ url_for('documentation_page') }}" class="btn btn-secondary" style="width: 100%; text-align: center;">
        üìñ View Documentation
    </a>
</div>
{% endblock %}

{% block content %}
<div id="character-creation">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <h1 style="color: #ffd700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); margin: 0 0 0.5rem 0;">üåü Create New Character</h1>
        <p style="color: #e0e0e0; margin: 0;">Build your Star Wars RPG character step by step</p>
    </div>

    <!-- Creation Form -->
    <form id="character-creation-form" style="background: linear-gradient(145deg, #1a1a2e, #16213e); border: 1px solid #333; border-radius: 8px; padding: 2rem;">
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
                <label class="form-label" style="color: #ffd700; font-weight: bold;">Character Name *</label>
                <input type="text" class="form-input" name="name" required placeholder="Enter character name" style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700;">
            </div>

            <div class="form-group">
                <label class="form-label" style="color: #ffd700; font-weight: bold;">Player Name *</label>
                <input type="text" class="form-input" name="playerName" required placeholder="Enter player name" style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700;">
            </div>
        </div>

        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
                <label class="form-label" style="color: #ffd700; font-weight: bold;">Species *</label>
                <select class="form-select" name="species" required style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700;">
                    <option value="">Select Species</option>
                    <optgroup label="Core Species">
                        <option value="Human">Human</option>
                        <option value="Twi'lek">Twi'lek</option>
                        <option value="Rodian">Rodian</option>
                        <option value="Wookiee">Wookiee</option>
                        <option value="Bothan">Bothan</option>
                    </optgroup>
                    <optgroup label="Additional Species">
                        <option value="Duros">Duros</option>
                        <option value="Gand">Gand</option>
                        <option value="Trandoshan">Trandoshan</option>
                        <option value="Cerean">Cerean</option>
                        <option value="Kel Dor">Kel Dor</option>
                        <option value="Nautolan">Nautolan</option>
                        <option value="Zabrak">Zabrak</option>
                        <option value="Mon Calamari">Mon Calamari</option>
                        <option value="Sullustan">Sullustan</option>
                        <option value="Chiss">Chiss</option>
                    </optgroup>
                    <optgroup label="Variant Humans">
                        <option value="Corellian Human">Corellian Human</option>
                        <option value="Mandalorian Human">Mandalorian Human</option>
                    </optgroup>
                    <optgroup label="Unique Species">
                        <option value="Jawa">Jawa</option>
                        <option value="Ewok">Ewok</option>
                        <option value="Devaronian">Devaronian</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" style="color: #ffd700; font-weight: bold;">Career *</label>
                <select class="form-select" name="career" required style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700;">
                    <option value="">Select Career</option>
                    <optgroup label="Edge of the Empire">
                        <option value="Bounty Hunter">Bounty Hunter</option>
                        <option value="Colonist">Colonist</option>
                        <option value="Explorer">Explorer</option>
                        <option value="Hired Gun">Hired Gun</option>
                        <option value="Smuggler">Smuggler</option>
                        <option value="Technician">Technician</option>
                    </optgroup>
                    <optgroup label="Age of Rebellion">
                        <option value="Ace">Ace</option>
                        <option value="Commander">Commander</option>
                        <option value="Diplomat">Diplomat</option>
                    </optgroup>
                    <optgroup label="Force and Destiny">
                        <option value="Consular">Consular</option>
                        <option value="Guardian">Guardian</option>
                        <option value="Mystic">Mystic</option>
                        <option value="Seeker">Seeker</option>
                        <option value="Sentinel">Sentinel</option>
                        <option value="Warrior">Warrior</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 2rem;">
            <label class="form-label" style="color: #ffd700; font-weight: bold;">Background (Optional)</label>
            <textarea class="form-input" name="background" rows="3" placeholder="Character background and motivation..." style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700; resize: vertical;"></textarea>
        </div>

        <!-- Campaign Assignment -->
        <div class="form-group" style="margin-bottom: 2rem;">
            <label class="form-label" style="color: #ffd700; font-weight: bold;">Assign to Campaign (Optional)</label>
            <select class="form-select" name="campaign_id" style="background: rgba(255, 255, 255, 0.1); color: #e0e0e0; border: 1px solid #ffd700;">
                <option value="">No Campaign (Assign Later)</option>
                <!-- Campaigns will be populated by JavaScript -->
            </select>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" style="display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Create Character</button>
        </div>
    </form>

    <!-- Creation Status -->
    <div id="creation-status" style="margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none;">
        <div id="status-message"></div>
    </div>
</div>

<style>
.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #ffed4e;
    box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
}

.form-input::placeholder {
    color: rgba(224, 224, 224, 0.5);
}

/* Mobile-first responsive design */
@media (max-width: 767px) {
    .form-row {
        grid-template-columns: 1fr !important;
        gap: 0.75rem;
    }
    
    .form-input, .form-select {
        font-size: 16px; /* Prevent zoom on iOS */
        min-height: 44px;
        padding: 0.875rem;
    }
    
    .btn {
        min-height: 44px;
        padding: 0.875rem 1rem;
    }
    
    .form-row .form-group {
        margin-bottom: 1rem;
    }
}

@media (max-width: 480px) {
    .form-row {
        gap: 0.5rem;
    }
    
    .form-input, .form-select {
        padding: 1rem;
    }
    
    .btn {
        padding: 1rem;
        font-size: 1rem;
    }
    
    .form-label {
        font-size: 0.9rem;
    }
}

.loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
}

.loading.show {
    display: flex;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #333;
    border-top: 2px solid #ffd700;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-success {
    background: rgba(56, 161, 105, 0.2);
    border: 1px solid #38a169;
    color: #38a169;
}

.status-error {
    background: rgba(229, 62, 62, 0.2);
    border: 1px solid #e53e3e;
    color: #e53e3e;
}

/* Additional mobile styles */
@media (max-width: 767px) {
    .action-buttons {
        justify-content: center !important;
    }
    
    .action-buttons .btn {
        flex: 1;
        text-align: center;
        min-width: calc(50% - 0.5rem);
    }
}

@media (max-width: 480px) {
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .action-buttons .btn:last-child {
        margin-bottom: 0;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let campaigns = [];

// Initialize page
document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication first
    await checkAuthentication();
    await loadCampaigns();
    setupFormHandling();
});

async function checkAuthentication() {
    try {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch('/api/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
            return;
        }
    } catch (error) {
        console.error('Authentication check failed:', error);
        window.location.href = '/login';
    }
}

async function loadCampaigns() {
    try {
        const response = await authenticatedFetch('/api/campaigns');
        if (response.ok) {
            const data = await response.json();
            campaigns = data.campaigns || [];
            populateCampaignSelect();
        }
    } catch (error) {
        console.error('Error loading campaigns:', error);
    }
}

function populateCampaignSelect() {
    const select = document.querySelector('select[name="campaign_id"]');
    
    // Clear existing options except the first one
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // Add campaign options
    campaigns.forEach(campaign => {
        const option = document.createElement('option');
        option.value = campaign.id;
        option.textContent = `${campaign.name} ${campaign.is_game_master ? '(GM)' : '(Player)'}`;
        select.appendChild(option);
    });
}

function setupFormHandling() {
    const form = document.getElementById('character-creation-form');
    form.addEventListener('submit', handleCharacterCreation);
}

async function handleCharacterCreation(event) {
    event.preventDefault();
    console.log('Character creation form submitted');
    
    const formData = new FormData(event.target);
    const characterData = {
        name: formData.get('name'),
        playerName: formData.get('playerName'),
        species: formData.get('species'),
        career: formData.get('career'),
        background: formData.get('background') || '',
        campaign_id: formData.get('campaign_id') || null
    };
    
    console.log('Character data:', characterData);
    
    // Validate required fields
    if (!characterData.name || !characterData.playerName || !characterData.species || !characterData.career) {
        console.log('Validation failed: missing required fields');
        showStatus('Please fill in all required fields.', 'error');
        return;
    }
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.innerHTML = '<div class="spinner"></div> Creating...';
    submitButton.disabled = true;
    
    try {
        console.log('Making API call to create character...');
        const response = await authenticatedFetch('/api/characters', {
            method: 'POST',
            body: JSON.stringify(characterData)
        });
        
        console.log('API response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Character created successfully:', result);
            showStatus('Character created successfully! Redirecting...', 'success');
            
            // Redirect to character sheet after short delay
            setTimeout(() => {
                window.location.href = `/character/${result.character.id}`;
            }, 1500);
        } else {
            const error = await response.json();
            console.error('API error:', error);
            showStatus('Error creating character: ' + error.error, 'error');
        }
    } catch (error) {
        console.error('Error creating character:', error);
        showStatus('Failed to create character. Please try again.', 'error');
    } finally {
        // Restore button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('creation-status');
    const messageDiv = document.getElementById('status-message');
    
    statusDiv.className = `status-${type}`;
    statusDiv.style.display = 'block';
    messageDiv.textContent = message;
    
    // Auto-hide success messages
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }
}

// Helper function for authenticated API calls
async function authenticatedFetch(url, options = {}) {
    const token = localStorage.getItem('access_token');
    return fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
}
</script>
{% endblock %}