{% extends "base.html" %}

{% block title %}Star Wars RPG Character Manager{% endblock %}

{% block layout %}
<!-- Full width layout without sidebar -->
<div style="max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1 style="color: #ffd700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); margin: 0 0 0.5rem 0;">‚≠ê My Characters</h1>
        <p style="color: #e0e0e0; margin: 0;">Manage your Star Wars RPG characters</p>
    </div>
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <input type="text" id="characterFilter" placeholder="Search characters..." 
               style="padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid #ffd700; border-radius: 4px; color: #e0e0e0; min-width: 200px;">
        <a href="{{ url_for('create_character_page') }}" class="btn">+ Create Character</a>
    </div>
</div>

<!-- Characters Grid -->
<div id="charactersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
    <!-- Characters will be loaded here -->
</div>

<!-- Empty State -->
<div id="emptyState" style="display: none; text-align: center; padding: 3rem 1rem; color: #a0aec0;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">üåü</div>
    <h2 style="color: #ffd700; margin: 0 0 1rem 0;">No Characters Yet</h2>
    <p style="margin-bottom: 2rem;">Create your first Star Wars RPG character to get started!</p>
    <a href="{{ url_for('create_character_page') }}" class="btn btn-lg">+ Create Character</a>
</div>

<!-- Loading State -->
<div id="loadingState" style="text-align: center; padding: 3rem 1rem; color: #a0aec0;">
    <div style="font-size: 2rem; margin-bottom: 1rem;">Loading characters...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Characters management
let allCharacters = [];

// Load characters on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadCharacters();
    setupCharacterFilter();
});

async function loadCharacters() {
    try {
        const response = await fetch('/api/characters');
        if (response.ok) {
            const data = await response.json();
            allCharacters = data.characters || [];
            displayCharacters(allCharacters);
            updateCharacterStats();
        } else {
            throw new Error('Failed to load characters');
        }
    } catch (error) {
        console.error('Error loading characters:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }
}

function displayCharacters(characters) {
    const grid = document.getElementById('charactersGrid');
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    
    loadingState.style.display = 'none';
    
    if (characters.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    grid.style.display = 'grid';
    
    grid.innerHTML = characters.map(character => `
        <div class="character-card" style="background: linear-gradient(145deg, #1a1a2e, #16213e); border: 1px solid #333; border-radius: 12px; padding: 2rem; transition: all 0.3s ease; min-width: 0; overflow: hidden;">
            <!-- Character Header -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h3 style="color: #ffd700; margin: 0 0 0.5rem 0; font-size: 1.4rem; font-weight: bold;">${character.name}</h3>
                <div style="color: #a0aec0; font-size: 1rem;">${character.species} ${character.career}</div>
                <div style="color: #e0e0e0; font-size: 0.875rem; margin-top: 0.25rem;">Player: ${character.playerName}</div>
            </div>
            
            <!-- XP Display -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 215, 0, 0.15); border-radius: 8px; text-align: center;">
                <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">Experience Points</div>
                <div style="color: #ffd700; font-size: 1.3rem; font-weight: bold; margin-top: 0.25rem;">${character.availableXP} / ${character.totalXP}</div>
            </div>
            
            <!-- Top 3 Characteristics Only -->
            <div style="margin-bottom: 1.5rem;">
                <div style="color: #ffd700; font-size: 1rem; font-weight: bold; text-align: center; margin-bottom: 0.75rem;">Top Characteristics</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                    <div style="text-align: center; padding: 0.75rem; background: rgba(255, 215, 0, 0.1); border-radius: 6px;">
                        <div style="color: #a0aec0; font-size: 0.8rem; margin-bottom: 0.25rem;">BRA</div>
                        <div style="color: #ffd700; font-weight: bold; font-size: 1.4rem;">${character.characteristics.brawn}</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: rgba(255, 215, 0, 0.1); border-radius: 6px;">
                        <div style="color: #a0aec0; font-size: 0.8rem; margin-bottom: 0.25rem;">AGI</div>
                        <div style="color: #ffd700; font-weight: bold; font-size: 1.4rem;">${character.characteristics.agility}</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: rgba(255, 215, 0, 0.1); border-radius: 6px;">
                        <div style="color: #a0aec0; font-size: 0.8rem; margin-bottom: 0.25rem;">INT</div>
                        <div style="color: #ffd700; font-weight: bold; font-size: 1.4rem;">${character.characteristics.intellect}</div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.75rem; justify-content: center;">
                <button onclick="editCharacter('${character.id}')" class="btn" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; flex: 1; max-width: 120px;">Edit</button>
                <button onclick="awardXP('${character.id}')" class="btn btn-outline" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; flex: 1; max-width: 120px;">Award XP</button>
            </div>
        </div>
    `).join('');
}

function setupCharacterFilter() {
    const filterInput = document.getElementById('characterFilter');
    filterInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filteredCharacters = allCharacters.filter(character => 
            character.name.toLowerCase().includes(query) ||
            character.species.toLowerCase().includes(query) ||
            character.career.toLowerCase().includes(query) ||
            character.playerName.toLowerCase().includes(query)
        );
        displayCharacters(filteredCharacters);
    });
}

function updateCharacterStats() {
    document.getElementById('totalCharacters').textContent = allCharacters.length;
    document.getElementById('activeCharacters').textContent = allCharacters.length; // For now, all are active
}

function editCharacter(characterId) {
    window.location.href = `/character/${characterId}`;
}

async function awardXP(characterId) {
    const amount = prompt('Enter XP amount to award:');
    if (!amount || isNaN(amount) || parseInt(amount) <= 0) return;
    
    const reason = prompt('Reason for XP award (optional):') || 'Manual award';
    
    try {
        const response = await fetch(`/api/characters/${characterId}/award-xp`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                amount: parseInt(amount),
                reason: reason
            })
        });
        
        if (response.ok) {
            alert(`Successfully awarded ${amount} XP!`);
            await loadCharacters(); // Reload to show updated XP
        } else {
            throw new Error('Failed to award XP');
        }
    } catch (error) {
        console.error('Error awarding XP:', error);
        alert('Failed to award XP. Please try again.');
    }
}

// Add hover effects to character cards
document.addEventListener('DOMContentLoaded', () => {
    const style = document.createElement('style');
    style.textContent = `
        .character-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
        }
    `;
    document.head.appendChild(style);
});
</script>

</div>
{% endblock %}